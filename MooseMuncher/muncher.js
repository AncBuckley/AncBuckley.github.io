import MooseMan from"./MooseMan.js";let Character=MooseMan;const canvas=document.getElementById("game"),ctx=canvas.getContext("2d"),menu=document.getElementById("menu"),help=document.getElementById("help"),gameover=document.getElementById("gameover"),startBtn=document.getElementById("startBtn"),againBtn=document.getElementById("againBtn"),menuBtn=document.getElementById("menuBtn"),pauseBtn=document.getElementById("pauseBtn"),helpBtn=document.getElementById("helpBtn"),closeHelp=document.getElementById("closeHelp"),difficulty=document.getElementById("difficulty"),categorySelect=document.getElementById("categorySelect"),modeSelect=document.getElementById("modeSelect"),gridSelect=document.getElementById("gridSelect"),levelSpan=document.getElementById("level"),scoreSpan=document.getElementById("score"),livesSpan=document.getElementById("lives"),toast=document.getElementById("toast"),catBadge=document.getElementById("categoryBadge"),levelProgress=document.getElementById("levelProgress"),rand=(t,e)=>Math.random()*(e-t)+t,randi=(t,e)=>Math.floor(rand(t,e)),choice=t=>t[Math.floor(Math.random()*t.length)],clamp=(t,e,a)=>Math.min(a,Math.max(e,t)),now=()=>performance.now(),shuffle=t=>{for(let e=t.length-1;e>0;e--){const a=randi(0,e+1);[t[e],t[a]]=[t[a],t[e]]}return t},easeOutCubic=t=>1-Math.pow(1-t,3),lerp=(t,e,a)=>t+(e-t)*a,esc=t=>String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;"),isPrime=t=>{if(t<2)return!1;if(t%2==0)return 2===t;const e=Math.sqrt(t)|0;for(let a=3;a<=e;a+=2)if(t%a==0)return!1;return!0};let WORD_SETS={},CATEGORIES=[];function applyCrossHints(t,e){if(!e)return t;const a=(t,e)=>t.some(t=>t.toLowerCase()===String(e).toLowerCase());for(const[n,o]of Object.entries(e))for(const e of o)t[e]=t[e]||[],a(t[e],n)||t[e].push(n);return t}function makeWordCategory(t,e,a=[],n="lower",o,i){const r=t=>"title"===n?String(t).replace(/\b\w/g,(t=>t.toUpperCase())):"upper"===n?String(t).toUpperCase():String(t),s=t=>String(t).toLowerCase(),l=new Set((e||[]).map(s)),c=[];for(const[t,e]of Object.entries(WORD_SETS))e&&(o&&t===o||c.push(...e));for(const t of a){const e=WORD_SETS[t];e&&c.push(...e)}const d=[...new Set(c.map(s))].filter((t=>!l.has(t)));return{id:o||t.toLowerCase().replace(/\s+/g,"-"),name:t,type:"word",sourceKey:i,labelCase:n,generate:(t,a,n=12)=>{const o=t*a,i=[...new Set((e||[]).map(String))],s=shuffle(i).slice(0,Math.min(n,o)),l=Math.max(0,o-s.length),c=d.length?shuffle(d):[],u=[];for(let t=0;t<l;t++){if(0===c.length)break;u.push(c[t%c.length])}const h=t=>{for(const e of Object.values(WORD_SETS)){const a=(e||[]).find((e=>s(e)===t));if(a)return String(a)}return t},g=u.map(h),p=[...s,...g].map((t=>({label:r(t),value:String(t),correct:l.has(s(t))})));return shuffle(p)}}}function numericCategory(t,e,a={}){const n=a.min??2,o=a.max??99;return{id:a.id||t.toLowerCase().replace(/\s+/g,"-"),name:t,type:"number",min:n,max:o,test:e,generate:(t,a)=>{const n=t*a,o=Array.from({length:o-n+1},((t,e)=>e+n)),i=shuffle(o).slice(0,n);return i.map((t=>({label:String(t),value:t,correct:!!e(t)})))}}}function buildCategoriesFromJSON(t){WORD_SETS=t.wordSets||{},WORD_SETS=applyCrossHints(WORD_SETS,t.crossHints);const e=[];for(const a of t.numbers||[]){let t=()=>!1;switch(a.kind){case"even":t=t=>t%2==0;break;case"odd":t=t=>t%2!=0;break;case"prime":t=t=>isPrime(t);break;case"multipleOf":{const e=a.k||1;t=t=>t%e==0;break}case"square":t=t=>Number.isInteger(Math.sqrt(t));break;case"factorsOf":{const e=a.n||1;t=t=>e%t==0;break}case"greaterThan":{const e=a.threshold??0;t=t=>t>e;break}case"lessThan":{const e=a.threshold??0;t=t=>t<e;break}}e.push(numericCategory(a.name,t,{id:a.id,min:a.min,max:a.max}))}for(const a of t.words||[]){const t=WORD_SETS[a.set]||[];e.push(makeWordCategory(a.name,t,a.distractFrom||[],a.case||"lower",a.id,a.set))}return e}async function loadCategories(){const t=new URL("./categories.json",import.meta.url).toString();try{const e=await fetch(t,{cache:"no-store"});if(!e.ok)throw new Error(`HTTP ${e.status} for ${t}`);const a=await e.json();CATEGORIES=buildCategoriesFromJSON(a)}catch(e){console.error("Failed to load categories.json, using minimal fallback. URL tried:",t,e),WORD_SETS={fruits:["apple","pear","mango","plum"],mammals:["cat","dog"],colors:["red","blue"]},CATEGORIES=[numericCategory("Even Numbers",(t=>t%2==0),{id:"even-numbers",min:2,max:50}),makeWordCategory("Fruits",WORD_SETS.fruits,["colors","mammals"],"lower","fruits","fruits")]}}const pickRandomCategory=t=>choice((CATEGORIES.filter((e=>e.id!==t))).length?CATEGORIES.filter((e=>e.id!==t)):CATEGORIES),pickRandomMathCategory=t=>{const e=CATEGORIES.filter((e=>"number"===e.type&&e.id!==t));return choice(e.length?e:CATEGORIES.filter((t=>"number"===t.type)))},computeMathNeeded=(t,e)=>Math.max(1,Math.floor(e*Math.pow(2,t-1))),DIRS={UP:0,RIGHT:1,DOWN:2,LEFT:3},DIR_VECT=[[0,-1],[1,0],[0,1],[-1,0]],ENEMY_STEP_MS=3e3,TROGGLE_COLORS=["#ff3b6b","#ffb800","#00e5ff","#7cff00","#ff00e5","#ff7a00","#00ffb3","#ffd700","#00ffd0","#ff4d00"];let state={running:!1,paused:!1,level:1,score:0,lives:3,gridW:12,gridH:8,tile:64,category:null,items:[],correctRemaining:0,player:null,enemies:[],freezeUntil:0,invulnUntil:0,lastTime:0,mode:"classic",math:{progress:0,base:6,needed:6}},explosions=[],starBursts=[],sfx=[],catFly=null,star=null;function resizeCanvas(){const t=window.devicePixelRatio||1,e=canvas.getBoundingClientRect();canvas.width=Math.floor(e.width*t),canvas.height=Math.floor(e.height*t),ctx.setTransform(t,0,0,t,0,0),state.tile=Math.floor(Math.min(e.width/state.gridW,e.height/state.gridH))}addEventListener("resize",resizeCanvas);function minCorrectForBoard(t,e){return Math.min(t*e,Math.max(12,"math"===state.mode?state.math.needed||12:12))}function buildBoard(){if(!state.category)return void console.warn("No category yet");const t=state.gridW,e=state.gridH,a=minCorrectForBoard(t,e);let n=state.category.generate(t,e,a),o=n.filter((t=>t.correct)).length,i=Math.max(6,Math.floor(t*e*.2));if(o<i){let a=n,r=o;for(let o=0;o<12;o++){const o=state.category.generate(t,e,a),i=o.filter((t=>t.correct)).length;if(i>r&&(a=o,r=i,r>=i))break}n=a}state.items=n.map(((a,n)=>({...a,eaten:!1,gx:n%t,gy:Math.floor(n/t)}))),state.correctRemaining=state.items.filter((t=>t.correct)).length,star=null}function spawnPlayer(){state.player={gx:0,gy:0,x:0,y:0,dir:DIRS.RIGHT,moving:null}}function spawnEnemies(){const t=state.level<=3?2:state.level<=6?3:4,e=clamp(t+(state.level>6?1:0),2,6);state.enemies=[];const a=new Set(["0,0"]),n=now();for(let t=0;t<e;t++){let e=randi(0,state.gridW),o=randi(0,state.gridH),i=0;for(;(Math.abs(e-0)+Math.abs(o-0))<Math.floor((state.gridW+state.gridH)/4)||a.has(`${e},${o}`);)if(e=randi(0,state.gridW),o=randi(0,state.gridH),++i>50)break;a.add(`${e},${o}`),state.enemies.push({gx:e,gy:o,x:e,y:o,dir:randi(0,4),color:choice(TROGGLE_COLORS),nextStepAt:n+ENEMY_STEP_MS+150*t})}}document.addEventListener("keydown",(t=>{const e=t.key.toLowerCase();["arrowup","arrowdown","arrowleft","arrowright","w","a","s","d"].includes(e)?(t.preventDefault(),t.repeat||handlePlayerStep(e)):" "!==e&&"enter"!==e||tryEat(),"p"===e&&togglePause(),"escape"===e&&(help.classList.contains("hide")?togglePause():help.classList.add("hide"))}));function handlePlayerStep(t){if(!state.running||state.paused||!state.player||state.player.moving)return;let e=null;"arrowup"!==t&&"w"!==t||(e=DIRS.UP),"arrowright"!==t&&"d"!==t||(e=DIRS.RIGHT),"arrowdown"!==t&&"s"!==t||(e=DIRS.DOWN),"arrowleft"!==t&&"a"!==t||(e=DIRS.LEFT);if(null==e)return;const[a,n]=DIR_VECT[e],o=state.player.gx+a,i=state.player.gy+n;if(passable(o,i)){const t=state.player.x,a=state.player.y;state.player.gx=o,state.player.gy=i,state.player.dir=e,state.player.moving={fromX:t,fromY:a,toX:o,toY:i,start:now(),dur:200}}}function startGame(){state.running=!0,state.paused=!1,state.level=1,state.score=0,state.lives=3,state.freezeUntil=0,state.invulnUntil=0,nextLevel()}function nextLevel(){"math"===state.mode&&(state.category=pickRandomMathCategory(state.category?state.category.id:null),state.math.needed=computeMathNeeded(state.level,state.math.base),state.math.progress=0,launchCategoryFly()),buildBoard(),spawnPlayer(),spawnEnemies(),updateHUD(),resetEnemyTimers(),state.invulnUntil=now()+1200}function resetEnemyTimers(){const t=now();state.enemies.forEach(((e,a)=>e.nextStepAt=t+ENEMY_STEP_MS+150*a))}function levelCleared(){state.score+=500,state.level+=1,nextLevel()}function loseLife(){if(!(now()<state.invulnUntil)){if(state.lives-=1,state.invulnUntil=now()+1500,showToast("Ouch!"),spawnExplosion(state.player.gx,state.player.gy),state.lives<=0)return void gameOver();state.player.gx=0,state.player.gy=0,state.player.x=0,state.player.y=0,state.player.dir=DIRS.RIGHT}}function gameOver(){state.running=!1,state.paused=!1,gameover.classList.remove("hide"),document.getElementById("finalStats").textContent=`You scored ${state.score}.`}function tryEat(){if(state.running&&!state.paused){const t=getTileAt(state.player.gx,state.player.gy);t&&!t.eaten&&(t.eaten=!0,t.correct?(state.score+=100,spawnStarBurstCell(t.gx,t.gy),"math"===state.mode?(state.math.progress=Math.min(state.math.needed,(state.math.progress||0)+1),state.math.progress>=state.math.needed&&setTimeout(levelCleared,350)):(state.correctRemaining-=1,state.correctRemaining<=0&&setTimeout(levelCleared,350)),Math.random()<.06&&spawnPowerUp(t.gx,t.gy),showToast("Yum! +100")):(state.score=Math.max(0,state.score-50),"math"===state.mode&&(state.math.progress=Math.max(0,(state.math.progress||0)-1)),spawnDisappointAt(state.player.gx,state.player.gy),loseLife(),showToast("Wrong! −50")),updateHUD())}}function spawnPowerUp(t,e){star={gx:t,gy:e,active:!0,born:now()}}function getTileAt(t,e){return state.items.find((a=>a.gx===t&&a.gy===e))}function passable(t,e){return t>=0&&e>=0&&t<state.gridW&&e<state.gridH}function roundRect(t,e,a,n,o,i){const r=Math.min(i,n/2,o/2);t.moveTo(e+r,a),t.arcTo(e+n,a,e+n,a+o,r),t.arcTo(e+n,a+o,e,a+o,r),t.arcTo(e,a+o,e,a,r),t.arcTo(e,a,e+n,a,r)}function wrapLabel(t,e,a,n=3){const o=String(t).split(" "),i=[];let r="";for(let t of o){const n=r?r+" "+t:t;if(a.measureText(n).width<=e)r=n;else{if(r&&(i.push(r),i.length>=n))return i;let o=t;for(;a.measureText(o).width>e;){let t=o.length;for(;t>1&&a.measureText(o.slice(0,t)).width>e;)t--;i.push(o.slice(0,t)),o=o.slice(t);if(i.length>=n)return i}r=o}}return r&&i.length<n&&i.push(r),i}function draw(){const t=canvas.getBoundingClientRect(),e="math"===state.mode?Math.max(90,.08*t.width):0,a=Math.min((t.width-e)/state.gridW,t.height/state.gridH),n=(t.width-e-state.gridW*a)/2,o=(t.height-state.gridH*a)/2;if(ctx.clearRect(0,0,canvas.width,canvas.height),state.player&&state.player.moving){const t=state.player.moving,e=(now()-t.start)/t.dur;if(e>=1)state.player.x=t.toX,state.player.y=t.toY,state.player.moving=null;else{const a=easeOutCubic(clamp(e,0,1));state.player.x=t.fromX+(t.toX-t.fromX)*a,state.player.y=t.fromY+(t.toY-t.fromY)*a}}for(const t of state.items){const e=n+t.gx*a,o=o+t.gy*a,i=14;ctx.beginPath(),roundRect(ctx,e+2,o+2,a-4,a-4,i);const r=ctx.createLinearGradient(e,o,e+a,o+a);r.addColorStop(0,t.eaten?"#0c1430":"#15204a"),r.addColorStop(1,t.eaten?"#0a1126":"#0e1737"),ctx.fillStyle=r,ctx.fill(),ctx.strokeStyle=t.eaten?"rgba(255,255,255,.06)":"rgba(255,255,255,.12)",ctx.lineWidth=1.2,ctx.stroke(),t.eaten?t.correct&&(ctx.save(),ctx.globalAlpha=.18,ctx.fillStyle="#9cff6d",ctx.beginPath(),ctx.arc(e+a/2,o+a/2,.18*a,0,2*Math.PI),ctx.fill(),ctx.restore()):(ctx.save(),ctx.fillStyle="rgba(230,240,255,.95)";const i=Math.floor(.23*a);ctx.font=`${i}px ui-sans-serif, system-ui, -apple-system, Segoe UI`,ctx.textAlign="center",ctx.textBaseline="middle";const r=.82*a,s=Math.max(16,Math.floor(1.05*i)),l=wrapLabel(t.label,r,ctx,3),c=l.length*s;let d=o+a/2-c/2+s/2;for(const t of l)ctx.fillText(t,e+a/2,d),d+=s;ctx.restore())}if(star&&star.active){const t=n+star.gx*a+a/2,e=o+star.gy*a+a/2;drawStar(ctx,t,e,5,.22*a,.09*a,"#ffd166")}if(state.player){const t=n+state.player.x*a+a/2,e=o+state.player.y*a+a/2,i=now()<state.invulnUntil,r=Character.computeAnim(state.player,DIR_VECT);Character.draw(ctx,t,e,.34*a,state.player.dir,i,r)}for(const t of state.enemies){const e=n+t.x*a+a/2,i=o+t.y*a+a/2,r=now()<state.freezeUntil;drawTroggle(ctx,e,i,.5*a,t.dir||0,t.color,r)}drawExplosions(ctx,n,o,a),drawStarBursts(ctx,n,o,a),drawSFX(ctx,n,o,a),drawCategoryFly(ctx,t),"math"===state.mode&&drawLevelBar(ctx,t,e)}function drawStar(t,e,a,n,o,i,r){const s=Math.PI/n;let l=-Math.PI/2;t.save(),t.beginPath();for(let c=0;c<n;c++)t.lineTo(e+Math.cos(l)*o,a+Math.sin(l)*o),l+=s,t.lineTo(e+Math.cos(l)*i,a+Math.sin(l)*i),l+=s;t.closePath(),t.fillStyle=r,t.fill(),t.restore()}function drawTroggle(t,e,a,n,o,i,r){t.save(),t.translate(e,a),t.rotate([-Math.PI/2,0,Math.PI/2,Math.PI][o]);const s=1.1*n,l=.9*n;t.shadowColor=i,t.shadowBlur=r?8:18,t.beginPath(),t.moveTo(-s/2,l/2),t.lineTo(0,-l/2),t.lineTo(s/2,l/2),t.closePath();const c=t.createLinearGradient(-s/2,-l/2,s/2,l/2);c.addColorStop(0,r?"#8af1ff":i),c.addColorStop(1,"#ffffff22"),t.fillStyle=c,t.fill(),t.shadowBlur=0,t.lineWidth=2,t.strokeStyle="rgba(255,255,255,.35)",t.stroke(),t.fillStyle="#fff",t.beginPath(),t.arc(-.2*n,-.06*n,.09*n,0,2*Math.PI),t.arc(.2*n,-.06*n,.09*n,0,2*Math.PI),t.fill(),t.fillStyle="#0b1020",t.beginPath(),t.arc(-.2*n,-.06*n,.045*n,0,2*Math.PI),t.arc(.2*n,-.06*n,.045*n,0,2*Math.PI),t.fill(),t.strokeStyle="rgba(255,255,255,.25)",t.lineWidth=1.2,t.beginPath(),t.moveTo(-.32*s,.15*l),t.lineTo(.32*s,.15*l),t.stroke(),t.restore()}function spawnExplosion(t,e){const a=18,n=[];for(let t=0;t<a;t++)n.push({ang:rand(0,2*Math.PI),spd:rand(.6,1.1)});explosions.push({gx:t,gy:e,born:now(),duration:650,parts:n})}function drawExplosions(t,e,a){const n=now();for(explosions=explosions.filter((t=>n-t.born<t.duration));const o of explosions){const i=clamp((n-o.born)/o.duration,0,1),r=e+o.gx*a+a/2,s=a+o.gy*a+a/2;t.save(),t.globalAlpha=.5*(1-i),t.beginPath(),t.arc(r,s,.15*a+.4*a*easeOutCubic(i),0,2*Math.PI),t.strokeStyle="#ff6d8a",t.lineWidth=2,t.stroke(),t.restore();for(const e of o.parts){const n=easeOutCubic(i)*e.spd*a*.9,l=r+Math.cos(e.ang)*n,c=s+Math.sin(e.ang)*n;t.save(),t.globalAlpha=1-i,t.fillStyle="#ff6d8a",t.beginPath(),t.arc(l,c,Math.max(1.5,3*(1-i)),0,2*Math.PI),t.fill(),t.restore()}}}function spawnStarBurstCell(t,e){const a=12,n=[];for(let t=0;t<a;t++)n.push({ang:rand(0,2*Math.PI),spd:rand(.6,1.1)});starBursts.push({gx:t,gy:e,born:now(),duration:700,parts:n})}function drawStarBursts(t,e,a){const n=now();for(starBursts=starBursts.filter((t=>n-t.born<t.duration));const o of starBursts){const i=clamp((n-o.born)/o.duration,0,1),r=e+o.gx*a+a/2,s=a+o.gy*a+a/2;for(const e of o.parts){const n=easeOutCubic(i)*e.spd*a*.95,l=r+Math.cos(e.ang)*n,c=s+Math.sin(e.ang)*n;t.save(),t.globalAlpha=1-i,drawStar(t,l,c,5,Math.max(2,.1*a*(1-i)),Math.max(1,.05*a*(1-i)),"#ffd166"),t.restore()}}}function spawnDisappointAt(t,e){sfx.push({type:"disappoint",gx:t,gy:e,born:now(),duration:800})}function drawSFX(t,e,a){const n=now();for(sfx=sfx.filter((t=>n-t.born<t.duration));const o of sfx)if("disappoint"===o.type){const i=clamp((n-o.born)/o.duration,0,1),r=e+o.gx*a+a/2,s=a+o.gy*a+a/2-.2*a;t.save(),t.strokeStyle="rgba(70,212,255,0.9)",t.lineWidth=2;const l=4;for(let e=0;e<l;e++){const a=(e-(l-1)/2)*.08*a,n=.22*a*(1-i);t.beginPath(),t.moveTo(r+a,s-.2*a),t.lineTo(r+a,s-.2*a+n),t.stroke()}t.restore(),t.save(),t.globalAlpha=1-i,t.fillStyle="#46d4ff",t.beginPath(),t.moveTo(r+.18*a,s-.06*a),t.quadraticCurveTo(r+.24*a,s+.02*a,r+.14*a,s+.1*a),t.quadraticCurveTo(r+.28*a,s+0,r+.18*a,s-.06*a),t.fill(),t.restore()}function launchCategoryFly(){catFly={text:state.category.name,start:now(),delay:1e3,dur:900}}function getBadgeCenterInCanvas(){const t=catBadge.getBoundingClientRect(),e=canvas.getBoundingClientRect();return{x:t.left-e.left+t.width/2,y:t.top-e.top+t.height/2}}function drawCategoryFly(t,e){if(!catFly)return;const a=now()-catFly.start,n={x:e.width/2,y:.42*e.height},o=getBadgeCenterInCanvas();if(a<catFly.delay)return t.save(),t.globalAlpha=.95,t.fillStyle="#e8f4ff",t.font="700 36px system-ui, -apple-system, Segoe UI",t.textAlign="center",t.textBaseline="middle",t.shadowColor="#46d4ff",t.shadowBlur=18,t.fillText(catFly.text,n.x,n.y),void t.restore();const i=clamp((a-catFly.delay)/catFly.dur,0,1),r=lerp(n.x,o.x,easeOutCubic(i)),s=lerp(n.y,o.y,easeOutCubic(i)),l=Math.round(36*(1.1-.15*i));t.save(),t.globalAlpha=1-.9*i,t.fillStyle="#e8f4ff",t.font=`700 ${l}px system-ui, -apple-system, Segoe UI`,t.textAlign="center",t.textBaseline="middle",t.shadowColor="#9cff6d",t.shadowBlur=18,t.fillText(catFly.text,r,s),t.restore(),i>=1&&(catFly=null)}function drawLevelBar(t,e,a){const n=Math.max(20,Math.floor(.5*a)),o=16,i=e.width-a+(a-n)/2,r=o,s=e.height-2*o;t.save(),t.fillStyle="#0a1437",t.strokeStyle="#20306b",t.lineWidth=1,roundRect(t,i,r,n,s,10),t.fill(),t.stroke();const l=clamp((state.math.progress||0)/(state.math.needed||1),0,1);t.save(),t.beginPath(),roundRect(t,i+2,r+2,n-4,(s-4)*l,8);const c=t.createLinearGradient(0,r+s,0,r);c.addColorStop(0,"#46d4ff"),c.addColorStop(1,"#9cff6d"),t.fillStyle=c,t.fill(),t.restore(),t.fillStyle="#cfe2ff",t.font="12px system-ui, sans-serif",t.textAlign="center",t.textBaseline="bottom",t.fillText(`${state.math.progress||0}/${state.math.needed||1}`,i+n/2,r+s-6),t.restore()}function enemyStep(){if(!(now()<state.freezeUntil))for(const t of state.enemies)if(now()>=t.nextStepAt){t.nextStepAt=now()+ENEMY_STEP_MS;const e=[0,1,2,3];shuffle(e);let a=t.dir||0,n=1/0;for(const o of e){const[e,i]=DIR_VECT[o],r=t.gx+e,s=t.gy+i;if(passable(r,s)){const e=Math.abs(r-state.player.gx)+Math.abs(s-state.player.gy);e<n&&(n=e,a=o)}}Math.random()<.35&&(a=choice([0,1,2,3]));const[e,a]=DIR_VECT[a],n=t.gx+e,o=t.gy+a;passable(n,o)&&(t.gx=n,t.gy=o,t.x=n,t.y=o,t.dir=a)}}function checkCollisions(){for(const t of state.enemies)t.gx===state.player.gx&&t.gy===state.player.gy&&loseLife();star&&star.active&&state.player.gx===star.gx&&state.player.gy===star.gy&&(star.active=!1,state.freezeUntil=now()+3500,showToast("Troggles frozen!"))}function updateHUD(){levelSpan.textContent=state.level,scoreSpan.textContent=state.score,livesSpan.textContent=state.lives;const t=catBadge.querySelector("strong");t&&(t.textContent=state.category?state.category.name:"–"),updateProgressBar()}function updateProgressBar(){if("math"!==state.mode)return void(levelProgress.style.width="0%");const t=clamp((state.math.progress||0)/(state.math.needed||1),0,1);levelProgress.style.width=`${Math.round(100*t)}%`}function showToast(t){toast.textContent=t,toast.classList.remove("hide"),clearTimeout(showToast._t),toast._t=setTimeout((()=>toast.classList.add("hide")),1200)}function togglePause(){state.running&&(state.paused=!state.paused,pauseBtn.textContent=state.paused?"▶️ Resume":"⏸️ Pause")}function loop(){state.running&&!state.paused&&(enemyStep(),checkCollisions(),draw()),requestAnimationFrame(loop)}function populateCategories(){categorySelect&&(CATEGORIES.length?(categorySelect.innerHTML=CATEGORIES.map((t=>`<option value="${esc(t.id)}">${esc(t.name)}</option>`)).join(""),CATEGORIES.length&&(categorySelect.value=state.category&&state.category.id||CATEGORIES[0].id),categorySelect.disabled="math"===modeSelect.value):(categorySelect.innerHTML="",categorySelect.disabled=!0))}function applyMenuSettings(){const[t,e]=gridSelect.value.split("x").map(Number);if(state.gridW=t,state.gridH=e,state.mode=modeSelect.value,"classic"===state.mode){const t=CATEGORIES.find((t=>t.id===categorySelect.value))||CATEGORIES[0];state.category=t}else state.category=pickRandomMathCategory(state.category?state.category.id:null),state.math.base=6,state.math.progress=0,state.math.needed=computeMathNeeded(1,state.math.base);resizeCanvas(),buildBoard(),spawnPlayer(),spawnEnemies(),resetEnemyTimers(),updateHUD(),updateProgressBar()}startBtn.addEventListener("click",(()=>{menu.classList.add("hide"),gameover.classList.add("hide"),applyMenuSettings(),state.running=!0,state.paused=!1,state.level=1,state.score=0,state.lives=3,state.freezeUntil=0,state.invulnUntil=0,updateHUD()})),againBtn.addEventListener("click",(()=>{gameover.classList.add("hide"),menu.classList.add("hide"),applyMenuSettings(),state.running=!0,state.paused=!1,state.level=1,state.score=0,state.lives=3,state.freezeUntil=0,state.invulnUntil=0,updateHUD()})),menuBtn.addEventListener("click",(()=>{gameover.classList.add("hide"),menu.classList.remove("hide"),state.running=!1})),helpBtn.addEventListener("click",(()=>{help.classList.remove("hide"),state.paused=!0,pauseBtn.textContent="▶️ Resume"})),closeHelp.addEventListener("click",(()=>help.classList.add("hide"))),pauseBtn.addEventListener("click",togglePause),document.getElementById("shuffleBtn").addEventListener("click",(()=>{"classic"===modeSelect.value&&(categorySelect.value=choice(CATEGORIES).id)})),modeSelect.addEventListener("change",(()=>{categorySelect.disabled="math"===modeSelect.value,"classic"===modeSelect.value&&populateCategories(),updateProgressBar()})),async function(){await loadCategories(),state.category=CATEGORIES[0]||null,populateCategories(),resizeCanvas(),updateHUD(),requestAnimationFrame(loop)}();
